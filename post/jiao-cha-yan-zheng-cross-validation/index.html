<html>
<head>
    <meta charset="utf-8"/>
<meta name="description" content=""/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>äº¤å‰éªŒè¯cross validation | ä¹±è°ˆåºœ      â€”â€”è©¹è©¹ç¢è¨€</title>

<link rel="shortcut icon" href="https://blog.laffitto.xyz/favicon.ico?v=1741015572497">

<link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://blog.laffitto.xyz/styles/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css">

<script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets/highlight.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dockerfile.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dart.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/moment@2.27.0/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.min.js"></script>
<!-- DEMO JS -->
<!--<script src="media/scripts/index.js"></script>-->


    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-160641909-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());
        gtag('config', 'UA-160641909-1');
    </script>


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.css">
</head>
<body>
<div class="main gt-bg-theme-color-first">
    <nav class="navbar navbar-expand-lg">
    <div class="navbar-brand">
        <img class="user-avatar" src="/images/avatar.png" alt="å¤´åƒ">
        <div class="site-name gt-c-content-color-first">
            ä¹±è°ˆåºœ      â€”â€”è©¹è©¹ç¢è¨€
        </div>
    </div>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <i class="fas fa-bars gt-c-content-color-first" style="font-size: 18px"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <div class="navbar-nav mr-auto" style="text-align: center">
            
                <div class="nav-item">
                    
                        <a href="/" class="menu gt-a-link">
                            ğŸ¯é¦–é¡µ
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/archives" class="menu gt-a-link">
                            âœ‰å½’æ¡£
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/tags" class="menu gt-a-link">
                            â˜æ ‡ç­¾äº‘é›†
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="https://memo.laffitto.xyz/" class="menu gt-a-link">
                            ğŸ’Œè©¹è©¹ç¢è¨€
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/post/about" class="menu gt-a-link">
                            ğŸ“å…³äºä¸ç•™è¨€
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/friends" class="menu gt-a-link">
                            ğŸ‘«å‹é“¾
                        </a>
                    
                </div>
            
        </div>
        <div style="text-align: center">
            <form id="gridea-search-form" style="position: relative" data-update="1741015572497" action="/search/index.html">
                <input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="æœç´¢æ–‡ç« " />
                <i class="fas fa-search gt-c-content-color-first" style="position: absolute; top: 9px; left: 10px;"></i>
            </form>
        </div>
    </div>
</nav>

    <div class="post-container">
        <div class="post-detail gt-bg-theme-color-second">
            <article class="gt-post-content">
                <h2 class="post-title">
                    äº¤å‰éªŒè¯cross validation
                </h2>
                <div class="post-info">
                    <time class="post-time gt-c-content-color-first">
                        Â· 2020-09-19 Â·
                    </time>
                    
                        <a href="https://blog.laffitto.xyz/tag/GOjnDzJhq/" class="post-tags">
                            # tensorflow
                        </a>
                    
                        <a href="https://blog.laffitto.xyz/tag/i1-Jje_9N/" class="post-tags">
                            # study
                        </a>
                    
                        <a href="https://blog.laffitto.xyz/tag/HQ-WIhH4M/" class="post-tags">
                            # python
                        </a>
                    
                </div>
                <div class="post-content">
                    <p>åŸºäºtensorflow2.0çš„äº¤å‰éªŒè¯å®ç°æ–¹æ³•ã€‚</p>
<!-- more -->
<h2 id="äº¤å‰éªŒè¯æ˜¯å•¥">äº¤å‰éªŒè¯æ˜¯å•¥</h2>
<p>æœºå™¨å­¦ä¹ æ¨¡å‹å¸¸å¸¸ä¸èƒ½å¾ˆå¥½åœ°å¯¹æœªç»è¿‡è®­ç»ƒçš„æ•°æ®è¿›è¡Œå½’çº³ã€‚æœ‰æ—¶å€™è¡¨ç°è‰¯å¥½ç„¶è€Œæœ‰äº›æ—¶å€™è¡¨ç°ç³Ÿç³•ã€‚ä¸ºäº†ç¡®ä¿æ¨¡å‹èƒ½åœ¨æœªè§æ•°æ®ä¸Šè¡¨ç°è‰¯å¥½ï¼Œå¼•å‡ºä½¿ä¸€ç§ç§°ä¸ºKæŠ˜äº¤å‰éªŒè¯ï¼ˆK-Fold cross-validationï¼‰çš„é‡æ–°é‡‡æ ·æŠ€æœ¯ã€‚</p>
<p>æˆ‘ä»¬è®­ç»ƒçš„æ—¶å€™é€šå¸¸å°†æ•°æ®åˆ†æˆä¸‰ä¸ªéƒ¨åˆ†ï¼Œå³<strong>è®­ç»ƒé›†</strong>ã€<strong>éªŒè¯é›†</strong>å’Œ<strong>æµ‹è¯•é›†</strong>ã€‚ä½†æ˜¯å¦‚æœå½“æ•°æ®é‡æœ‰é™æ—¶ï¼Œå°†æ•°æ®é›†åˆ’åˆ†ä¸ºè®­ç»ƒé›†å’ŒéªŒè¯é›†ï¼Œå¯èƒ½ä¼šå¯¼è‡´ä¸€äº›å…·æœ‰æœ‰ç”¨ä¿¡æ¯çš„æ•°æ®ç‚¹è¢«æ’é™¤åœ¨è®­ç»ƒè¿‡ç¨‹ä¹‹å¤–ï¼Œå¯¼è‡´æ¨¡å‹æ— æ³•æ­£ç¡®åœ°å­¦ä¹ æ•°æ®çš„åˆ†å¸ƒã€‚è¿™æ—¶å€™äº¤å‰éªŒè¯å¯ä»¥åšå‡ºä¸€äº›æ”¹è¿›ï¼š<br>
<img src="https://cdn.jsdelivr.net/gh/laffitto/Pic_bed/20200920172813.png" alt="cross-validation" loading="lazy"></p>
<p>ä¸å…¶ä»–æ–¹æ³•ç›¸æ¯”ï¼ŒK-Fold ç»™å‡ºäº†ä¸€ä¸ªåå·®è¾ƒå°çš„æ¨¡å‹ã€‚åœ¨k - fold ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªå‚æ•°kã€‚è¿™ä¸ªå‚æ•°å†³å®šæ•°æ®é›†å°†è¢«åˆ’åˆ†çš„æŠ˜å æ•°ã€‚æ¯ä¸€æ¬¡æŠ˜å éƒ½æœ‰æœºä¼šå‡ºç°åœ¨è®­ç»ƒé›†(k-1)ä¸­ï¼Œè¿™åè¿‡æ¥åˆç¡®ä¿äº†æ•°æ®é›†ä¸­çš„æ¯ä¸€æ¬¡è§‚å¯Ÿéƒ½å‡ºç°åœ¨æ•°æ®é›†ä¸­ï¼Œä»è€Œä½¿æ¨¡å‹èƒ½å¤Ÿæ›´å¥½åœ°å­¦ä¹ åº•å±‚æ•°æ®åˆ†å¸ƒã€‚å¦‚ä¸Šå›¾ä¸­kçš„å€¼ä¸º5ã€‚</p>
<p>ä½¿ç”¨çš„kå€¼ä¸€èˆ¬åœ¨5æˆ–10ä¹‹é—´ã€‚kçš„å€¼ä¸åº”è¯¥å¤ªä½æˆ–å¤ªé«˜ã€‚å¦‚æœkçš„å€¼å¤ªä½(æ¯”å¦‚k = 2)ï¼Œæˆ‘ä»¬å°†å¾—åˆ°ä¸€ä¸ªé«˜åº¦åç½®çš„æ¨¡å‹ã€‚è¿™ç§æƒ…å†µç±»ä¼¼äºå°†æ•°æ®é›†æ‹†åˆ†ä¸ºè®­ç»ƒé›†å’ŒéªŒè¯é›†ï¼Œå› æ­¤åå·®ï¼ˆbiasï¼‰è¾ƒé«˜ï¼Œæ–¹å·®ï¼ˆvarianceï¼‰è¾ƒä½ã€‚å¦‚æœkçš„å€¼å¾ˆå¤§(æ¯”å¦‚k = n(æ€»ä½“çš„æ•°é‡))ï¼Œé‚£ä¹ˆè¿™ç§æ–¹æ³•ç§°ä¸º<strong>Leave One Out CV (LOOCV)</strong>ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåå·®ä¼šå¾ˆä½ï¼Œä½†æ–¹å·®ä¼šå¾ˆé«˜ï¼Œæ¨¡å‹ä¼šè¿‡åº¦æ‹Ÿåˆï¼Œå¯¼è‡´æ¨¡å‹æ— æ³•åœ¨æµ‹è¯•é›†ä¸Šæ¨å¹¿ã€‚</p>
<p>å¦ä¸€ç§æ–¹æ³•æ˜¯åœ¨å°†æ•°æ®é›†æ‹†åˆ†ä¸ºkæ¬¡æŠ˜å ä¹‹å‰åªå°†æ•°æ®é›†æ´—ç‰Œä¸€æ¬¡ï¼Œç„¶åå†æ‹†åˆ†ï¼Œè¿™æ ·æ¯ä¸ªç±»ä¸­çš„è§‚å¯Ÿå€¼çš„åˆ†å¸ƒåœ¨æ¯æ¬¡æŠ˜å ä¸­ä¿æŒä¸å˜ã€‚æµ‹è¯•é›†ä¹Ÿä¸ä¼šåœ¨è¿ç»­çš„è¿­ä»£ä¹‹é—´é‡å ã€‚è¿™ç§æ–¹æ³•ç§°ä¸º<strong>Stratified K-Fold</strong>ã€‚è¯¥æ–¹æ³•é€‚ç”¨äºä¸å¹³è¡¡æ•°æ®é›†ã€‚</p>
<h2 id="å…·ä½“ä»£ç å®ç°">å…·ä½“ä»£ç å®ç°</h2>
<p>è¿™é‡Œçš„ç¼–ç¨‹ç¯å¢ƒæ˜¯Tensorflow2.0ï¼Œè¦å®ç°äº¤å‰éªŒè¯çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œå¯ä»¥å€ŸåŠ©sklearnåº“çš„KFoldå’ŒStratifiedKFoldç±»ã€‚</p>
<pre><code class="language-python">from sklearn.model_selection import KFold, StratifiedKFold
</code></pre>
<p>å…·ä½“ä½¿ç”¨æ–¹æ³•å¯ä»¥å‚è€ƒå®˜æ–¹wikiï¼š<a href="https://scikit-learn.org/stable/modules/generated/sklearn.model_selection.KFold.html">KFold</a>å’Œ<a href="https://scikit-learn.org/stable/modules/generated/sklearn.model_selection.StratifiedKFold.html">StratifiedKFold</a></p>
<p>å¯ä»¥å…ˆå‚è€ƒå¦‚ä¸‹æ–‡ç« ï¼Œå‰ä¸¤ä¸ªå…·æœ‰æå¤§çš„å‚è€ƒä»·å€¼ï¼š</p>
<ol>
<li>
<p><a href="https://www.machinecurve.com/index.php/2020/02/18/how-to-use-k-fold-cross-validation-with-keras/"><strong>How to use K-fold Cross Validation with Keras?</strong></a></p>
</li>
<li>
<p><a href="https://medium.com/the-owl/k-fold-cross-validation-in-keras-3ec4a3a00538"><strong>K-Fold Cross Validation for Deep Learning Models using Keras</strong></a></p>
</li>
<li>
<p><a href="https://www.kaggle.com/stefanie04736/simple-keras-model-with-k-fold-cross-validation">Simple Keras Model with k-fold cross validation</a></p>
</li>
<li>
<p><a href="https://machinelearningmastery.com/k-fold-cross-validation/">A Gentle Introduction to k-fold Cross-Validation</a></p>
</li>
</ol>
<h2 id="å®ç°">å®ç°</h2>
<p>è¿™æ˜¯è‡ªå·±è‡ªå·±å†ç»¼åˆè¿‡ç¨‹ä¸­å®Œæˆçš„ä»£ç ç‰‡æ®µï¼š</p>
<pre><code class="language-python">#coding:utf-8
# Based on tensorflow 2.2
from model_verTF2 import class_net
from data import *
from tensorflow.keras import callbacks
import tensorflow as tf
from sklearn.model_selection import KFold, StratifiedKFold
import os

# enable GPU
os.environ['CUDA_VISIBLE_DEVICES'] = '0'
config = tf.compat.v1.ConfigProto(allow_soft_placement=True)
config.gpu_options.per_process_gpu_memory_fraction = 0.8
tf.compat.v1.keras.backend.set_session(tf.compat.v1.Session(config=config))

# Model confiuration
BATCH_SIZE = 2
EPOCH = 200
FOLD = 9
path = './train_image'
save_dir = './saved_models/'

fold_var = 1
total_data = len(os.listdir(path))
labels = get_all_label(path)

# Define K-fold cross validation
kf = KFold(n_splits=FOLD, shuffle=True, random_state=6)
skf = StratifiedKFold(n_splits=FOLD, random_state=6, shuffle=True)

VALIDATION_ACCURACY = []
VALIDATION_LOSS = []

# Train by cross validation
for train_index, val_index in skf.split(np.zeros(total_data),labels):

    train_iter = batch_generator_cross_validation(path=path, index=train_index, 		  batch_size=BATCH_SIZE,train=True)
    val_iter = batch_generator_cross_validation(path=path, index=val_index, batch_size=BATCH_SIZE,train=False)

    model = class_net()
    ckpt = callbacks.ModelCheckpoint(save_dir+get_model_name(fold_var),
                                     monitor='val_accuracy', verbose=1,
                                     save_best_only=True, mode='max')
    log = callbacks.CSVLogger(save_dir+'model_log'+str(fold_var)+'.csv')
    callbacks_list = [ckpt, log]

    print('--------------------------------------------------------')
    print(f'Training for fold {fold_var} ...')
    history = model.fit(x=train_iter,
                        steps_per_epoch=len(train_index)/BATCH_SIZE,
                        epochs=EPOCH,
                        validation_data=val_iter,
                        validation_steps=len(val_index)/BATCH_SIZE,
                        callbacks=callbacks_list)

    plot_log(save_dir+'model_log'+str(fold_var)+'.csv')

    # load best model to evaluate
    model.load_weights(&quot;./saved_models/model_&quot;+str(fold_var)+&quot;.h5&quot;)

    results = model.evaluate(x=val_iter, steps=len(val_index)/BATCH_SIZE)
    results = dict(zip(model.metrics_names, results))

    VALIDATION_ACCURACY.append(results['accuracy'])
    VALIDATION_LOSS.append(results['loss'])

    tf.keras.backend.clear_session()

    fold_var += 1

print('----------------------------------------')
print('Score per fold')
for i in range(0, len(VALIDATION_LOSS)):
    print('------------------------------------------')
    print(f'&gt; Flod {i+1} - Val_loss:{VALIDATION_LOSS[i]} - Val_accuracy:{VALIDATION_ACCURACY[i]}')
</code></pre>
<p>ä»£ç æ®µä¸å¤ªå®Œæ•´ï¼Œç•™ä½œè‡ªå·±ä»¥åæ£€æŸ¥æ—¶è°ƒç”¨ï¼Œå¾…é¡¹ç›®å®Œæˆä¼šæ”¾åˆ°githubä¸Šå¼€æºï¼Œæ¯•ç«Ÿå¤ªè¾£é¸¡ï¼Œåªèƒ½å„ç§æ‹¼å‡‘ä¸€ä¸‹å‹‰å¼ºç»´æŒä¸€ä¸‹ç”Ÿæ´»çš„æ ·å­ã€‚ğŸ˜±</p>

                </div>
            </article>
        </div>

        
            <div class="next-post">
                <div class="next gt-c-content-color-first">ä¸‹ä¸€ç¯‡</div>
                <a href="https://blog.laffitto.xyz/post/zhan-zhan-sui-yan-4/" class="post-title gt-a-link">
                    è©¹è©¹ç¢è¨€ #4
                </a>
            </div>
        

        

        

        
            <script src='https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js'></script>

<style>
	div#vcomments{
		width:100%;
		max-width: 1000px;
		padding: 2.5%
	}
</style>


	<div id="vcomments"></div>

<script>
	new Valine({
		el: '#vcomments',
		appId: 'AnAyH2UNFKN6f5QhPUdWhX0P-MdYXbMMI',
		appKey: 'WB66M0LovKWi8iGgUlXB5xHM',
		avatar: '',
		pageSize: 5,
		recordIp: false,
		placeholder: 'Just Go Go',
		visitor: false,
	});
</script>

        

        <div class="site-footer gt-c-content-color-first">
    <div class="slogan gt-c-content-color-first">Aspire to inspire until I expire ğŸ¸
ä¹Ÿæ‰¯æ·¡ï¼Œä¹Ÿæ€è€ƒï¼Œä¹Ÿç”Ÿæ´»</div>
    <div class="social-container">
        
            
                <a href="https://github.com/laffitto" target="_blank">
                    <i class="fab fa-github gt-c-content-color-first"></i>
                </a>
            
        
            
                <a href="https://twitter.com/LaffitteRat" target="_blank">
                    <i class="fab fa-twitter gt-c-content-color-first"></i>
                </a>
            
        
            
        
            
        
            
                <a href="https://t.me/laffitto" target="_blank">
                    <i class="fab fa-telegram gt-c-content-color-first"></i>
                </a>
            
        
            
        
    </div>
    <div class="footer-info">
        Copyright Â© Laffitto 2019|Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
    </div>
    <div>
        Theme by <a href="https://imhanjie.com/" target="_blank">imhanjie</a>, Powered by <a
                href="https://github.com/getgridea/gridea" target="_blank">Gridea | <a href="https://blog.laffitto.xyz/atom.xml" target="_blank">RSS</a></a>
    </div>
</div>

<script>
  hljs.initHighlightingOnLoad()
</script>

    </div>
</div>
</body>
</html>
